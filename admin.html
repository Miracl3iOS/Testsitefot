<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Админка</title>
<style>
:root{
  --bg:#f0f0f3; --card:#f7f7fb; --ink:#2f2f36;
  --shadow:5px 5px 10px #cfcfd6, -5px -5px 10px #ffffff;
  --inset:inset 5px 5px 10px #cfcfd6, inset -5px -5px 10px #ffffff;
  --maxw:900px; --gap:12px;
}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial;-webkit-font-smoothing:antialiased}
.main{width:min(100vw,var(--maxw));margin:0 auto;min-height:100dvh;background:var(--bg);box-shadow:var(--shadow);border-radius:24px;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px}
.title{font-weight:900}
.wrap{padding:14px 16px 22px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap)}
.card{background:var(--card);box-shadow:var(--shadow);border-radius:16px;padding:14px}
.card h3{margin:0 0 8px;font-size:16px}
.kpi{font-size:28px;font-weight:900;margin:6px 0 0}
.table{width:100%;border-collapse:collapse;font-size:13.5px}
.table th,.table td{padding:8px;border-bottom:1px dashed #ddd;text-align:left}
.form-row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin-bottom:10px}
input[type="text"]{width:100%;padding:10px;border-radius:12px;border:none;background:#fff;box-shadow:var(--shadow);font-weight:600}
.save-btn{display:inline-block;margin-top:6px;padding:10px 14px;border-radius:12px;background:#111;color:#fff;font-weight:900;text-decoration:none;box-shadow:var(--shadow)}
hr{border:0;border-top:1px solid #e5e5ea;margin:12px 0}
.small{font-size:12px;color:#666}
</style>
</head>
<body>
<main class="main">
  <div class="header">
    <div class="title">Админка</div>
    <div class="small">Простая и надёжная</div>
  </div>

  <section class="wrap">
    <!-- KPI -->
    <div class="grid" id="kpis">
      <div class="card"><h3>Сегодня</h3><div class="kpi" id="k_day">—</div><div id="c_day" class="small"></div></div>
      <div class="card"><h3>Неделя</h3><div class="kpi" id="k_week">—</div><div id="c_week" class="small"></div></div>
      <div class="card"><h3>Месяц</h3><div class="kpi" id="k_month">—</div><div id="c_month" class="small"></div></div>
      <div class="card"><h3>Всего</h3><div class="kpi" id="k_all">—</div><div id="c_all" class="small"></div></div>
    </div>

    <hr/>

    <!-- Последние заходы -->
    <div class="card">
      <h3>Последние посещения</h3>
      <table class="table" id="visitsTable">
        <thead><tr><th>Время</th><th>IP</th><th>Страна</th><th>Путь</th><th>Реферер</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <hr/>

    <!-- Редактор ссылок -->
    <div class="card">
      <h3>Ссылки (кнопки/страницы)</h3>
      <div class="form-row"><label>Страница колеса</label><input id="link_fortune" type="text" placeholder="fortune.html"></div>
      <div class="form-row"><label>Ссылка «РАБОТА»</label><input id="link_job" type="text" placeholder="#"></div>
      <hr/>
      <div class="form-row"><label>Оператор</label><input id="btn_operator" type="text"></div>
      <div class="form-row"><label>Чаты</label><input id="btn_chats" type="text"></div>
      <div class="form-row"><label>Отзывы</label><input id="btn_reviews" type="text"></div>
      <div class="form-row"><label>Бот автопродаж</label><input id="btn_bot" type="text"></div>
      <div class="form-row"><label>Канал</label><input id="btn_channel" type="text"></div>
      <div class="form-row"><label>Обменник</label><input id="btn_exchanger" type="text"></div>
      <div class="form-row"><label>Вакансии</label><input id="btn_jobs" type="text"></div>
      <div class="form-row"><label>Поддержка</label><input id="btn_support" type="text"></div>
      <a href="#" class="save-btn" id="saveLinks">Сохранить</a>
      <div class="small" id="saveStatus"></div>
    </div>
  </section>
</main>

<script>
function fmtTs(ts){
  const d=new Date(ts);
  const z=n=>String(n).padStart(2,'0');
  return `${z(d.getDate())}.${z(d.getMonth()+1)} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}

async function loadStats(){
  const r = await fetch('/api/admin/stats'); const s = await r.json();
  const fill=(id,val)=>document.getElementById(id).textContent = val;
  fill('k_day',   s.day.visits);
  fill('k_week',  s.week.visits);
  fill('k_month', s.month.visits);
  fill('k_all',   s.all.visits);

  function countriesHTML(arr){
    if(!arr||!arr.length) return '—';
    return arr.map(x=>`${x.country||'Unknown'}: ${x.c}`).join(' · ');
  }
  document.getElementById('c_day').textContent   = countriesHTML(s.day.countries);
  document.getElementById('c_week').textContent  = countriesHTML(s.week.countries);
  document.getElementById('c_month').textContent = countriesHTML(s.month.countries);
  document.getElementById('c_all').textContent   = countriesHTML(s.all.countries);
}

async function loadVisits(){
  const r = await fetch('/api/admin/visits?limit=100'); const arr = await r.json();
  const tb = document.querySelector('#visitsTable tbody');
  tb.innerHTML = '';
  arr.forEach(v=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtTs(v.ts)}</td>
      <td>${(v.ip||'').replace(/^::ffff:/,'')}</td>
      <td>${v.country||'Unknown'}</td>
      <td>${v.path||'/'}</td>
      <td title="${v.ref||''}">${(v.ref||'').slice(0,50)}</td>
    `;
    tb.appendChild(tr);
  });
}

async function loadLinks(){
  const r = await fetch('/api/admin/links'); const data = await r.json();
  document.getElementById('link_fortune').value = data.fortune || 'fortune.html';
  document.getElementById('link_job').value     = data.job || '#';
  const b = data.buttons || {};
  const map = {
    operator:'btn_operator', chats:'btn_chats', reviews:'btn_reviews', bot:'btn_bot',
    channel:'btn_channel', exchanger:'btn_exchanger', jobs:'btn_jobs', support:'btn_support'
  };
  for(const k in map){ document.getElementById(map[k]).value = b[k] || ''; }
}

async function saveLinks(){
  const payload = {
    fortune: document.getElementById('link_fortune').value.trim(),
    job:     document.getElementById('link_job').value.trim(),
    buttons: {
      operator:  document.getElementById('btn_operator').value.trim(),
      chats:     document.getElementById('btn_chats').value.trim(),
      reviews:   document.getElementById('btn_reviews').value.trim(),
      bot:       document.getElementById('btn_bot').value.trim(),
      channel:   document.getElementById('btn_channel').value.trim(),
      exchanger: document.getElementById('btn_exchanger').value.trim(),
      jobs:      document.getElementById('btn_jobs').value.trim(),
      support:   document.getElementById('btn_support').value.trim()
    }
  };
  const r = await fetch('/api/admin/links', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  const ok = (await r.json()).ok;
  const st = document.getElementById('saveStatus');
  st.textContent = ok ? 'Сохранено' : 'Ошибка';
  setTimeout(()=>st.textContent='', 1500);
}

document.getElementById('saveLinks').addEventListener('click', (e)=>{e.preventDefault(); saveLinks();});

// первая загрузка
loadStats(); loadVisits(); loadLinks();
// автообновление KPI раз в минуту
setInterval(loadStats, 60000);
</script>
</body>
</html>
